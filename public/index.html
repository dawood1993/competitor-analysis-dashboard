<!DOCTYPE html>
<html>
<head>
  <title>Competitor Analysis Dashboard</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      padding: 20px; 
      background-color: #f5f5f5;
      margin: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 10px;
    }
    .subtitle {
      text-align: center;
      color: #7f8c8d;
      margin-bottom: 30px;
    }
    textarea { 
      width: 100%; 
      height: 120px; 
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      font-size: 14px;
      resize: vertical;
      box-sizing: border-box;
    }
    button { 
      background-color: #3498db;
      color: white;
      border: none;
      padding: 12px 30px; 
      margin-top: 15px; 
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    button:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
    }
    #response { 
      margin-top: 25px; 
      white-space: pre-wrap; 
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #3498db;
      min-height: 50px;
      font-family: 'Courier New', monospace;
      line-height: 1.6;
    }
    .loading {
      color: #3498db;
      font-style: italic;
    }
    .examples {
      background-color: #e8f6f3;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .examples h3 {
      margin-top: 0;
      color: #27ae60;
    }
    .example-query {
      background-color: white;
      padding: 10px;
      margin: 8px 0;
      border-radius: 4px;
      cursor: pointer;
      border: 1px solid #ddd;
      transition: background-color 0.2s;
    }
    .example-query:hover {
      background-color: #f1f2f6;
    }
    .dataset-info {
      background-color: #fff3cd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #ffc107;
    }
    .data-status {
      background-color: #d4edda;
      color: #155724;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      border-left: 4px solid #28a745;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöó Car Rental Competitor Analysis Dashboard</h1>
    <p class="subtitle">AI-Powered Insights for Saudi Arabia Car Rental Market</p>
    
    <div id="dataStatus" class="data-status">
      üìä Loading competitor data...
    </div>

    <div class="examples">
      <h3>üìä Sample Questions You Can Ask:</h3>
      <div class="example-query" onclick="fillQuestion(this)">Which Entity has the lowest average prices for vehicle (eg. Toyota Hiace Passenger Van)?</div>
      <div class="example-query" onclick="fillQuestion(this)">Which entity dominates each vehicle group (e.g., economy, SUV, luxury) in terms of pricing advantage</div>
      <div class="example-query" onclick="fillQuestion(this)">Who is the expensive rental company in each major city based on price competitiveness?</div>
      <div class="example-query" onclick="fillQuestion(this)">Analyze Downtown vs other location_type pricing differences</div>
      <div class="example-query" onclick="fillQuestion(this)">What are the key drivers behind price differences? How does pricing vary by branch location, vehicle group, and vehicle make/model?</div>
    </div>

    <textarea id="question" placeholder="Ask your question about car rental competitor analysis...

Examples:
- Compare Lumi vs other entities pricing for Passenger Vehicles
- Which branch location has the most competitive pricing?
- Show pricing analysis for different Vehicle_Groups
- What's the average price difference between different rental_duration_days?"></textarea>
    <br>
    <button onclick="askGPT()">üîç Analyze Data</button>
    <div id="response">AI analysis will appear here...</div>
  </div>

  <script>
    let competitorData = [];
    let dataSummary = {};

    async function loadCompetitorData() {
      try {
        const response = await fetch('competitor_analysis.json');
        competitorData = await response.json();
        
        // Generate comprehensive data summary
        dataSummary = {
          total_records: competitorData.length,
          entities: [...new Set(competitorData.map(r => r.Entity))],
          branch_locations: [...new Set(competitorData.map(r => r['branch location']))],
          vehicle_groups: [...new Set(competitorData.map(r => r.Vehicle_Group))],
          rental_durations: [...new Set(competitorData.map(r => r.rental_duration_days))].sort((a,b) => a-b),
          location_types: [...new Set(competitorData.map(r => r.location_type))],
          vehicle_models: [...new Set(competitorData.map(r => r.Vehicle_Make_Model))],
          price_range: {
            min: Math.min(...competitorData.map(r => r.price_SAR)),
            max: Math.max(...competitorData.map(r => r.price_SAR)),
            avg: (competitorData.reduce((sum, r) => sum + r.price_SAR, 0) / competitorData.length).toFixed(2)
          }
        };

        // Update status
        document.getElementById('dataStatus').innerHTML = 
          `‚úÖ Dataset loaded successfully: ${dataSummary.total_records} records covering ${dataSummary.entities.length} entities across ${dataSummary.branch_locations.length} locations`;
        
        console.log('Loaded competitor data:', competitorData.length, 'records');
        console.log('Data summary:', dataSummary);
      } catch (error) {
        console.error('Error loading competitor data:', error);
        document.getElementById('dataStatus').innerHTML = 
          '<span style="color: red;">‚ùå Error: Could not load competitor_analysis.json file. Please ensure the file is in the public folder.</span>';
      }
    }

    function fillQuestion(element) {
      document.getElementById('question').value = element.textContent;
    }

    async function askGPT() {
      const questionElement = document.getElementById('question');
      const responseElement = document.getElementById('response');
      const button = document.querySelector('button');
      
      const question = questionElement.value.trim();
      
      if (!question || question.length < 5) {
        responseElement.innerHTML = '<span style="color: red;">Please enter a more detailed question.</span>';
        return;
      }

      if (competitorData.length === 0) {
        responseElement.innerHTML = '<span style="color: red;">Competitor data not loaded. Please refresh the page.</span>';
        return;
      }

      // Disable button and show loading
      button.disabled = true;
      button.textContent = 'üîÑ Analyzing...';
      responseElement.innerHTML = '<span class="loading">ü§ñ AI is analyzing the complete competitor dataset...</span>';

      // Create comprehensive prompt with FULL dataset
      let prompt = `You are a car rental industry analyst for the Saudi Arabia market. My Entity is Lumi. Analyze this competitor dataset and answer the user's question with specific insights, numbers, and actionable recommendations.

DATASET OVERVIEW:
- Total Records: ${dataSummary.total_records}
- Entities: ${dataSummary.entities.join(', ')}
- Vehicle Groups: ${dataSummary.vehicle_groups.join(', ')}
- Rental Durations: ${dataSummary.rental_durations.join(', ')} days
- Location Types: ${dataSummary.location_types.join(', ')}
- Price Range: ${dataSummary.price_range.min} - ${dataSummary.price_range.max} SAR (avg: ${dataSummary.price_range.avg} SAR)
- Total Branch Locations: ${dataSummary.branch_locations.length}
- Total Vehicle Models: ${dataSummary.vehicle_models.length}

COLUMN STRUCTURE:
- Entity: Company name (e.g., lumi, theeb, budget saudi)
- branch location: Specific branch location (e.g., Jizan city Branch)
- rental_duration_days: Number of rental days
- location_type: Type of location (e.g., Downtown)
- Vehicle_Make_Model: Vehicle make and model (e.g., TOYOTA Hiace Passenger Van)
- Vehicle_Group: Category of vehicle (e.g., Passenger Vehicles, Electric)
- price_SAR: Rental price in Saudi Riyals

COMPLETE DATASET (ALL ${dataSummary.total_records} RECORDS):
${JSON.stringify(competitorData, null, 2)}

USER QUESTION: ${question}

Please provide:
1. Direct answer with specific numbers/percentages calculated from the complete dataset
2. Key insights and patterns identified across all records
3. Competitive positioning analysis for Lumi vs competitors
4. Business recommendations based on comprehensive data analysis
5. Use bullet points and clear formatting for readability

Important: Base your analysis on the COMPLETE dataset above, not just samples. Provide accurate calculations and insights.`;

      try {
        const response = await fetch("http://localhost:8080/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt })
        });

        const result = await response.json().catch(() => ({ 
          error: "Invalid JSON response from server" 
        }));

        if (result.response) {
          responseElement.innerHTML = `<strong>üéØ Analysis Results (Based on ${dataSummary.total_records} records):</strong>\n\n${result.response}`;
        } else {
          responseElement.innerHTML = `<span style="color: red;">‚ùå Error: ${result.error || "No response received"}</span>`;
        }

      } catch (error) {
        console.error('Request failed:', error);
        responseElement.innerHTML = `<span style="color: red;">‚ùå Connection Error: ${error.message}</span>`;
      } finally {
        // Re-enable button
        button.disabled = false;
        button.textContent = 'üîç Analyze Data';
      }
    }

    // Load data when page loads
    loadCompetitorData();
  </script>
</body>
</html>