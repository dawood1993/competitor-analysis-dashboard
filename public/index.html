<!DOCTYPE html>
<html>
<head>
  <title>Competitor Analysis Dashboard</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      padding: 20px; 
      background-color: #f5f5f5;
      margin: 0;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #2c3e50;
      text-align: center;
      margin-bottom: 10px;
    }
    .subtitle {
      text-align: center;
      color: #7f8c8d;
      margin-bottom: 30px;
    }
    textarea { 
      width: 100%; 
      height: 200px; 
      border: 2px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      font-size: 14px;
      resize: vertical;
      box-sizing: border-box;
    }
    button { 
      background-color: #3498db;
      color: white;
      border: none;
      padding: 12px 30px; 
      margin-top: 15px; 
      margin-right: 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #2980b9;
    }
    button:disabled {
      background-color: #bdc3c7;
      cursor: not-allowed;
    }
    #response { 
      margin-top: 25px; 
      white-space: pre-wrap; 
      background-color: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #3498db;
      min-height: 50px;
      font-family: 'Courier New', monospace;
      line-height: 1.6;
    }
    #response strong {
      font-weight: bold;
      color: #2c3e50;
    }
    .loading {
      color: #3498db;
      font-style: italic;
    }
    .dataset-info {
      background-color: #fff3cd;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #ffc107;
    }
    .data-status {
      background-color: #d4edda;
      color: #155724;
      padding: 10px;
      border-radius: 5px;
      margin-bottom: 15px;
      border-left: 4px solid #28a745;
    }
    .button-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üöó Car Rental Competitor Analysis Dashboard</h1>
    <p class="subtitle">AI-Powered Insights for Saudi Arabia Car Rental Market</p>
    
    <div id="dataStatus" class="data-status">
      üìä Loading competitor data...
    </div>

    <textarea id="question" placeholder="Ask your question about car rental competitor analysis...

Examples:
- Which Entity has the lowest average prices for vehicle (eg. Toyota Hiace Passenger Van)?
- Which entity dominates each vehicle group (e.g., economy, SUV, luxury) in terms of pricing advantage?
- Who is the expensive rental company in each major city based on price competitiveness?
- Analyze Downtown vs other location_type pricing differences
- What are the key drivers behind price differences? How does pricing vary by branch location, vehicle group, and vehicle make/model?"></textarea>
    <br>
    
    <div class="button-group">
      <button onclick="askGPT()">üîç Analyze Data</button>
    </div>
    
    <div id="response">AI analysis will appear here...</div>
  </div>

  <script>
    let competitorData = [];
    let competitorCSV = '';
    let dataSummary = {};
    let lastGeneratedPrompt = '';

    async function loadCompetitorData() {
      try {
        // Load as CSV text instead of JSON
        const response = await fetch('competitor_analysis.csv');
        competitorCSV = await response.text();
        
        // Parse for summary statistics only
        const lines = competitorCSV.split('\n').filter(line => line.trim());
        const headers = lines[0].split(',');
        const dataRows = lines.slice(1);
        
        // Parse minimal data for summary
        competitorData = dataRows.map(row => {
          const values = row.split(',');
          const record = {};
          headers.forEach((header, index) => {
            record[header.trim()] = values[index]?.trim();
          });
          // Convert price to number for calculations
          if (record.price_SAR) {
            record.price_SAR = parseFloat(record.price_SAR);
          }
          if (record.rental_duration_days) {
            record.rental_duration_days = parseInt(record.rental_duration_days);
          }
          return record;
        });
        
        // Generate summary without full data
        dataSummary = {
          total_records: competitorData.length,
          entities: [...new Set(competitorData.map(r => r.Entity))],
          branch_locations: [...new Set(competitorData.map(r => r['branch location']))],
          vehicle_groups: [...new Set(competitorData.map(r => r.Vehicle_Group))],
          rental_durations: [...new Set(competitorData.map(r => r.rental_duration_days))].sort((a,b) => a-b),
          location_types: [...new Set(competitorData.map(r => r.location_type))],
          vehicle_models: [...new Set(competitorData.map(r => r.Vehicle_Make_Model))],
          price_range: {
            min: Math.min(...competitorData.map(r => r.price_SAR)),
            max: Math.max(...competitorData.map(r => r.price_SAR)),
            avg: (competitorData.reduce((sum, r) => sum + r.price_SAR, 0) / competitorData.length).toFixed(2)
          }
        };

        // Update status
        document.getElementById('dataStatus').innerHTML = 
          `‚úÖ Dataset loaded successfully: ${dataSummary.total_records} records covering ${dataSummary.entities.length} entities across ${dataSummary.branch_locations.length} locations`;
        
        console.log('Loaded competitor CSV data:', dataSummary.total_records, 'records');
        console.log('CSV size:', competitorCSV.length, 'characters');
      } catch (error) {
        console.error('Error loading competitor data:', error);
        document.getElementById('dataStatus').innerHTML = 
          '<span style="color: red;">‚ùå Error: Could not load competitor_analysis.csv file. Please ensure the file is in the public folder.</span>';
      }
    }

    function generatePrompt(question) {
      return `${question}`;
    }

    async function askGPT() {
      const questionElement = document.getElementById('question');
      const responseElement = document.getElementById('response');
      const button = document.querySelector('button');
      
      const question = questionElement.value.trim();
      
      if (!question || question.length < 5) {
        responseElement.innerHTML = '<span style="color: red;">Please enter a more detailed question.</span>';
        return;
      }

      if (!competitorCSV || competitorCSV.length === 0) {
        responseElement.innerHTML = '<span style="color: red;">Competitor data not loaded. Please refresh the page.</span>';
        return;
      }

      // Disable button and show loading
      button.disabled = true;
      button.textContent = 'üîÑ Analyzing...';
      responseElement.innerHTML = '<span class="loading">ü§ñ AI is analyzing the complete competitor dataset...</span>';

      // Generate the prompt
      const prompt = generatePrompt(question);
      lastGeneratedPrompt = prompt;

      const promptSize = prompt.length;
      const estimatedTokens = Math.ceil(promptSize / 3.5); // Rough estimate: 1 token ‚âà 3.5 characters
      
      console.log(`Sending CSV dataset with ${dataSummary.total_records} records to AI`);
      console.log(`Prompt size: ${promptSize} characters (~${estimatedTokens} tokens)`);

      if (estimatedTokens > 800000) { // Conservative limit
        responseElement.innerHTML = `<span style="color: orange;">‚ö†Ô∏è Warning: Dataset may be too large (${estimatedTokens} estimated tokens). Consider using a smaller subset or different analysis approach.</span>`;
        button.disabled = false;
        button.textContent = 'üîç Analyze Data';
        return;
      }

      try {
        const response = await fetch("http://localhost:8080/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ prompt })
        });

        const result = await response.json().catch(() => ({ 
          error: "Invalid JSON response from server" 
        }));

        if (result.response) {
          const formattedResponse = formatAIResponse(result.response);
          responseElement.innerHTML = `<strong>üéØ Complete Analysis Results (Based on ALL ${dataSummary.total_records} records):</strong>\n\n${formattedResponse}`;
        } else {
          responseElement.innerHTML = `<span style="color: red;">‚ùå Error: ${result.error || "No response received"}</span>`;
        }

      } catch (error) {
        console.error('Request failed:', error);
        responseElement.innerHTML = `<span style="color: red;">‚ùå Connection Error: ${error.message}\n\nThis might be due to token limits. Consider breaking down your analysis into smaller segments.</span>`;
      } finally {
        // Re-enable button
        button.disabled = false;
        button.textContent = 'üîç Analyze Data';
      }
    }

    function formatAIResponse(text) {
      // Handle all markdown-style formatting while preserving line breaks
      return text
        // Convert **text** to <strong>text</strong>
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // Convert ### Headers to styled headers
        .replace(/^### (.+)$/gm, '<span style="font-weight: bold; font-size: 1.1em; color: #2c3e50; display: block; margin: 15px 0 8px 0;">$1</span>')
        // Convert ## Headers to styled headers
        .replace(/^## (.+)$/gm, '<span style="font-weight: bold; font-size: 1.2em; color: #2c3e50; display: block; margin: 15px 0 8px 0;">$1</span>')
        // Convert # Headers to styled headers
        .replace(/^# (.+)$/gm, '<span style="font-weight: bold; font-size: 1.3em; color: #2c3e50; display: block; margin: 15px 0 10px 0;">$1</span>')
        // Convert --- horizontal rules to styled dividers
        .replace(/^---$/gm, '<div style="border-top: 2px solid #ddd; margin: 15px 0;"></div>')
        // Convert bullet points starting with - to styled bullets
        .replace(/^- (.+)$/gm, '‚Ä¢ $1')
        // Convert numbered lists
        .replace(/^\d+\. (.+)$/gm, function(match, p1, offset, string) {
          const lineNumber = (string.substring(0, offset).match(/^\d+\. /gm) || []).length + 1;
          return lineNumber + '. ' + p1;
        });
    }

    // Load data when page loads
    loadCompetitorData();
  </script>
</body>
</html>